<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f7f6;
      padding: 20px;
    }
    h1 {
      color: #4CAF50;
    }
    select, button, input {
      font-size: 16px;
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 100%;
    }
    #loading {
      display: none;
      color: green;
    }
    #statusMessage {
      color: red;
      margin-top: 20px;
    }
    #csvUploadSection {
      display: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Generate CSV</h1>

  <!-- Team input box -->
  <label for="teamInput">Team:</label>
  <input type="text" id="teamInput" readonly />

  <!-- Application Name input box -->
  <label for="appNameInput">App Name:</label>
  <input type="text" id="appNameInput" readonly />

  <!-- Date input box -->
  <label for="dateInput">Date:</label>
  <input type="text" id="dateInput" readonly />

  <!-- Month input box -->
  <label for="monthInput">Month:</label>
  <input type="text" id="monthInput" readonly />

  <!-- Year input box -->
  <label for="yearInput">Year:</label>
  <input type="text" id="yearInput" readonly />

  <!-- Generate CSV button -->
  <button id="generateCsvButton" onclick="generateCsv()">Generate CSV</button>

  <p id="loading">Loading applications, please wait...</p>
  
  <div id="statusMessage"></div>

  <!-- CSV Upload Section -->
  <div id="csvUploadSection">
    <h2>Upload CSV</h2>
    <label for="csvUpload">Upload CSV:</label>
    <input type="file" id="csvUpload" />
  </div>

  <script>
    // Function to load applications and populate input boxes
    function loadApplications() {
      document.getElementById('loading').style.display = 'block';
      
      google.script.run.withSuccessHandler(function(applications) {
        document.getElementById('loading').style.display = 'none';

        if (applications.length === 0) {
          document.getElementById('statusMessage').innerText = "No applications found!";
          return;
        }

        // Auto-populate the first application's data
        if (applications.length > 0) {
          const firstApp = applications[0];
          document.getElementById('teamInput').value = firstApp.team;
          document.getElementById('appNameInput').value = firstApp.name;
        }

        // Populate date, month, and year fields with current date
        const today = new Date();
        document.getElementById('dateInput').value = today.getDate();
        document.getElementById('monthInput').value = today.toLocaleString('default', { month: 'long' });
        document.getElementById('yearInput').value = today.getFullYear();
      }).getApplications();
    }

    // Function to handle CSV generation and download
    function generateCsv() {
      let statusMessage = document.getElementById('statusMessage');

      // Display a generating message
      statusMessage.innerText = "Generating CSV, please wait...";
      statusMessage.style.color = "blue";

      // Run the Apps Script function to generate the CSV
      google.script.run.withSuccessHandler(function(downloadUrl) {
        
        // Trigger the download of the report
        const anchor = document.createElement('a');
        anchor.href = downloadUrl;
        anchor.download = `Report-${document.getElementById('teamInput').value}-${document.getElementById('appNameInput').value}-${document.getElementById('dateInput').value}-${document.getElementById('monthInput').value}-${document.getElementById('yearInput').value}.csv`; // Customize the download filename
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);

        // Final status message after download starts
        const reportName = `Macroscope Scan ${document.getElementById('teamInput').value} ${document.getElementById('appNameInput').value} - ${document.getElementById('dateInput').value}-${document.getElementById('monthInput').value}-${document.getElementById('yearInput').value}`;
        statusMessage.innerText = `Report for "${reportName}" downloaded successfully!`;
        statusMessage.style.color = "green";

        // Show the CSV upload section after download
        document.getElementById('csvUploadSection').style.display = 'block';

      }).generateCSV();
    }

    // Load the applications when the page loads
    document.addEventListener('DOMContentLoaded', loadApplications);
  </script>

</body>
</html>
